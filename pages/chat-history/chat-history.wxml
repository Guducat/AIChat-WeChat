<!--pages/chat-history/chat-history.wxml-->
<wxs module="formatter" src="./chat-history.wxs"></wxs>
<view class="history-container">
  <!-- å¤´éƒ¨æ“ä½œæ  -->
  <view class="header-actions">
    <van-button
      size="small"
      type="default"
      icon="search"
      bind:click="onToggleSearch"
      custom-class="action-btn"
    >
      æœç´¢
    </van-button>
    <van-button
      size="small"
      type="danger"
      icon="delete"
      bind:click="onClearAll"
      disabled="{{isEmpty}}"
      custom-class="action-btn"
    >
      æ¸…ç©º
    </van-button>
  </view>

  <!-- æœç´¢æ¡† -->
  <view class="search-container" wx:if="{{showSearch}}">
    <van-field
      value="{{searchKeyword}}"
      placeholder="æœç´¢å¯¹è¯è®°å½•..."
      left-icon="search"
      clearable
      bind:input="onSearchInput"
      custom-class="search-field"
    />
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <van-loading type="spinner" size="24px" color="#3cc51f" />
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- è°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ -->
  <!-- <view class="debug-info" wx:if="{{!loading}}">
    <text>è°ƒè¯•ä¿¡æ¯ï¼š</text>
    <text>filteredHistoryé•¿åº¦: {{filteredHistory.length}}</text>
    <text>chatHistoryé•¿åº¦: {{chatHistory.length}}</text>
    <text>isEmpty: {{isEmpty}}</text>
    <text>loading: {{loading}}</text>
    <text>showSearch: {{showSearch}}</text>
    <text>searchKeyword: {{searchKeyword}}</text>
  </view> -->

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-container" wx:if="{{!loading && (isEmpty || filteredHistory.length === 0)}}">
    <view class="empty-icon">ğŸ’¬</view>
    <text class="empty-text">
      {{isEmpty ? 'æš‚æ— å¯¹è¯è®°å½•' : 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å¯¹è¯'}}
    </text>
    <text class="empty-desc">
      {{isEmpty ? 'å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡AIå¯¹è¯å§' : 'å°è¯•å…¶ä»–å…³é”®è¯æœç´¢'}}
    </text>
    <van-button
      wx:if="{{isEmpty}}"
      type="primary"
      size="small"
      bind:click="onStartNewChat"
      custom-class="start-chat-btn"
    >
      å¼€å§‹å¯¹è¯
    </van-button>
  </view>

  <!-- å¯¹è¯è®°å½•åˆ—è¡¨ -->
  <view
    wx:if="{{!loading && !isEmpty && filteredHistory.length > 0}}"
    class="history-list"
  >
    <view
      wx:for="{{filteredHistory}}"
      wx:key="id"
      class="history-item-simple"
      bind:tap="onContinueChat"
      data-chat-id="{{item.id}}"
    >
      <view class="item-content">
        <view class="item-header">
          <view class="chat-title">{{item.title || 'æ— æ ‡é¢˜'}}</view>
          <view class="chat-time">{{item.formattedTime || 'æ— æ—¶é—´'}}</view>
        </view>

        <view class="item-body">
          <view class="chat-preview">{{formatter.formatMessageCount(item.messages)}} æ¡æ¶ˆæ¯</view>
          <view class="chat-meta">
            <text class="tag">{{item.scenarioName || 'æ— åœºæ™¯'}}</text>
            <text class="tag">{{item.modelName || 'æ— æ¨¡å‹'}}</text>
            <!-- å¤šæ¨¡æ€æ ‡è¯† -->
            <text
              wx:if="{{item.hasImages}}"
              class="tag multimodal"
            >
              ğŸ“· å›¾æ–‡
            </text>
          </view>
        </view>

        <view class="item-footer">
          <view class="chat-stats">
            <text class="stat-item">{{formatter.formatMessageCount(item.messages)}} æ¡æ¶ˆæ¯</text>
            <text class="stat-item">{{formatter.formatTokens(item.totalTokens)}} tokens</text>
            <text class="stat-item">Â¥{{formatter.formatCost(item.totalCost)}}</text>
          </view>
        </view>
      </view>

      <!-- ç®€åŒ–çš„æ“ä½œæŒ‰é’® -->
      <view class="item-actions">
        <view
          class="action-btn delete-btn"
          catch:tap="onDeleteChat"
          data-chat-id="{{item.id}}"
          data-title="{{item.title}}"
          data-index="{{index}}"
        >
          <van-icon name="delete-o" size="14px" color="#ee0a24" />
          åˆ é™¤
        </view>
      </view>
    </view>
  </view>
</view>

<!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
<van-dialog
  show="{{showDeleteConfirm}}"
  title="ç¡®è®¤åˆ é™¤"
  message="{{deleteConfirmMessage}}"
  show-cancel-button
  confirm-button-text="åˆ é™¤"
  confirm-button-color="#ee0a24"
  bind:confirm="onConfirmDelete"
  bind:cancel="onCancelDelete"
/>

<!-- Toastç»„ä»¶ -->
<van-toast id="van-toast" />